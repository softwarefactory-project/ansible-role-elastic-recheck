---
# NOTE: /usr directory can not be mount inside the container.
- name: Create directories for Opensearch
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ elk_uid }}"
    group: "{{ elk_gid }}"
    mode: "0777"
  loop:
    - "/etc/opensearch"
    - "{{ elk_data_dir }}"
    - "{{ elk_log_dir}}"
  when: elasticsearch_distro | lower == 'opensearch'

- name: Create Elasticsearch config file
  template:
    src: templates/elasticsearch_config.yml.j2
    dest: "{{ elk_config_path }}"
  register: _common_config

- name: Configure jvm Elasticsearch settings
  lineinfile:
    dest: /etc/elasticsearch/jvm.options
    regexp: "^#?{{ item.regexp }}.*"
    line: "{{ item.line }}"
    create: "{{ item.create | default(true) }}"
  loop:
    - regexp: "-Xms"
      line: "-Xms{{ elasticsearch_minimum_heap_size }}"
      dest: /etc/elasticsearch/jvm.options
    - regexp: "-Xmx"
      line: "-Xmx{{ elasticsearch_maximum_heap_size }}"
      dest: /etc/elasticsearch/jvm.options
  when: elasticsearch_distro | lower == 'opendistro'

- name: Set permissions for opensearch config file
  file:
    path: "{{ elk_config_path }}"
    owner: "{{ elk_uid }}"
    group: "{{ elk_gid }}"
    mode: "0777"
  when: elasticsearch_distro | lower == 'opensearch'

# https://opensearch.org/docs/opensearch/install/important-settings/
- name: Set important settings for Opensearch container
  sysctl:
    name: vm.max_map_count
    value: '262144'
    state: present
    reload: true

- name: Restart service if necessary
  service:
    name: elasticsearch
    state: restarted
    enabled: true
  ignore_errors: "{{ true if elasticsearch_distro | lower == 'opensearch' else false }}"
  when: _common_config.changed

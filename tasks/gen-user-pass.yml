---
- name: "Generate user"
  block:
    - name: Generate hash for user
      command: "{{ opendistro_plugin_dir }}/tools/hash.sh -p{{ item.password }}"
      register: _generated_hash
      environment:
        JAVA_HOME: "{{ java_home }}"

    - name: Set Elasticsearch users as a fact - internal user
      set_fact:
        "{{ item.user }}": "{{ item.password }}"
        "{{ item.user }}_hash": "{{ _generated_hash.stdout }}"
      when: is_internal_user

    # NOTE: for internal users, it would be: elasticsearch_admin and
    # elasticsearch_admin_hash, where for external users:
    # elasticsearch_admin_myinfra2 and elasticsearch_admin_myinfra2_hash
    - name: Set Elasticsearch users as a fact
      set_fact:
        "elasticsearch_{{ item.user }}_{{ item.tenant | replace('.', '_') }}": "{{ item.password }}"
        "elasticsearch_{{ item.user }}_{{ item.tenant | replace('.', '_') }}_hash": "{{ _generated_hash.stdout }}"
      when: not is_internal_user
  when:
    - "'password' in item"
    - "'user' in item"
  no_log: False

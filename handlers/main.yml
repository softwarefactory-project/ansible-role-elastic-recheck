---
# https://opendistro.github.io/for-elasticsearch-docs/docs/security/configuration/generate-certificates/#run-securityadminsh
- name: reconfigure security plugin
  shell: >
    {{ elk_plugin_dir }}/tools/securityadmin.sh \
      -cd {{ elk_plugin_dir }}/securityconfig/ \
      -icl -nhnv -cacert {{ elk_stack_certs }}/localCA.pem \
      -cert {{ elk_stack_certs }}/elasticsearch-admin.crt \
      -key {{ elk_stack_certs }}/elasticsearch-admin.key \
      -h {{ ansible_default_ipv4.address }}
  environment:
    JAVA_HOME: "{{ java_home }}"
  when: elasticsearch_distro | lower == 'opendistro'

- name: reconfigure security plugin in containers
  shell: >-
    podman exec opensearch
    bash -c 'JAVA_HOME=/usr/share/opensearch/jdk
    /usr/share/opensearch/plugins/opensearch-security/tools/securityadmin.sh
    -cd /usr/share/opensearch/plugins/opensearch-security/securityconfig/
    -icl -nhnv -cacert {{ elk_opensearch_config }}/localCA.pem
    -cert {{ elk_opensearch_config }}/elasticsearch-admin.crt
    -key {{ elk_opensearch_config }}/elasticsearch-admin.key
    -h {{ ansible_default_ipv4.address }}'
  when: elasticsearch_distro | lower == 'opensearch'
